import React$1, { PureComponent } from 'react';
import { clamp as clamp$1 } from '../../utilities/clamp.ts.esnext';
import { hsbToRgb } from '../../utilities/color-transformers.ts.esnext';
import styles from './ColorPicker.scss.esnext';
import { Slidable as Slidable$1 } from './components/Slidable/Slidable.tsx.esnext';
import { AlphaPicker as AlphaPicker$1 } from './components/AlphaPicker/AlphaPicker.tsx.esnext';
import { HuePicker as HuePicker$1 } from './components/HuePicker/HuePicker.tsx.esnext';

class ColorPicker extends PureComponent {
  constructor(...args) {
    super(...args);
    this.state = {
      pickerSize: 0
    };
    this.colorNode = null;

    this.setColorNode = node => {
      this.colorNode = node;
    };

    this.handleHueChange = hue => {
      const {
        color: {
          brightness,
          saturation,
          alpha = 1
        },
        onChange
      } = this.props;
      onChange({
        hue,
        brightness,
        saturation,
        alpha
      });
    };

    this.handleAlphaChange = alpha => {
      const {
        color: {
          hue,
          brightness,
          saturation
        },
        onChange
      } = this.props;
      onChange({
        hue,
        brightness,
        saturation,
        alpha
      });
    };

    this.handleDraggerMove = ({
      x,
      y
    }) => {
      const {
        pickerSize
      } = this.state;
      const {
        color: {
          hue,
          alpha = 1
        },
        onChange
      } = this.props;
      const saturation = clamp$1(x / pickerSize, 0, 1);
      const brightness = clamp$1(1 - y / pickerSize, 0, 1);
      onChange({
        hue,
        saturation,
        brightness,
        alpha
      });
    };

    this.handlePickerDrag = event => {
      // prevents external elements from being selected
      event.preventDefault();
    };
  }

  componentDidMount() {
    const {
      colorNode
    } = this;

    if (colorNode == null) {
      return;
    }

    this.setState({
      pickerSize: colorNode.clientWidth
    });

    if (process.env.NODE_ENV === 'development') {
      setTimeout(() => {
        this.setState({
          pickerSize: colorNode.clientWidth
        });
      }, 0);
    }
  }

  render() {
    const {
      id,
      color,
      allowAlpha
    } = this.props;
    const {
      hue,
      saturation,
      brightness,
      alpha: providedAlpha
    } = color;
    const {
      pickerSize
    } = this.state;
    const alpha = providedAlpha != null && allowAlpha ? providedAlpha : 1;
    const {
      red,
      green,
      blue
    } = hsbToRgb({
      hue,
      saturation: 1,
      brightness: 1
    });
    const colorString = `rgba(${red}, ${green}, ${blue}, ${alpha})`;
    const draggerX = clamp$1(saturation * pickerSize, 0, pickerSize);
    const draggerY = clamp$1(pickerSize - brightness * pickerSize, 0, pickerSize);
    const alphaSliderMarkup = allowAlpha ? /*#__PURE__*/React$1.createElement(AlphaPicker$1, {
      alpha: alpha,
      color: color,
      onChange: this.handleAlphaChange
    }) : null;
    return /*#__PURE__*/React$1.createElement("div", {
      className: styles.ColorPicker,
      id: id,
      onMouseDown: this.handlePickerDrag
    }, /*#__PURE__*/React$1.createElement("div", {
      ref: this.setColorNode,
      className: styles.MainColor
    }, /*#__PURE__*/React$1.createElement("div", {
      className: styles.ColorLayer,
      style: {
        backgroundColor: colorString
      }
    }), /*#__PURE__*/React$1.createElement(Slidable$1, {
      onChange: this.handleDraggerMove,
      draggerX: draggerX,
      draggerY: draggerY
    })), /*#__PURE__*/React$1.createElement(HuePicker$1, {
      hue: hue,
      onChange: this.handleHueChange
    }), alphaSliderMarkup);
  }

}

export { ColorPicker };
